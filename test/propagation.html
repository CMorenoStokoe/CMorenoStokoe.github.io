<html>

    <!--

    Data test page
    ---------------
    
    Intended purpose:

    Testing that data, graph theory and propagation functions 
    work in their intended purpose by performing content 
    and existence checks.
    
    -->

<head>

    <!-- Bootstrap css theme --> 
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    
    <!-- Fa icons -->
    <script src="https://kit.fontawesome.com/ff3502b087.js" crossorigin="anonymous"></script>
    
</head>

<body style="font-family: consolas;">

    <style>
        .created_class{border: 0.1pt solid rgb(150, 150, 150); padding: 20px;}
        .blue{font-size: 1.1em;}
    </style>

    <h1>Test page</h1>
    <p id="test_results" style="margin-bottom: 0px; background-color: red;">Testing failure. Check console.</p>
    <p id="test_log" style="color: white; background-color: black;"></p>


    <div class="row">
        
        <div class="col-6">

            <div class="card"  style="margin: 5px; height: 95%; width: 95%;">
                <div class=card-header>
                    <h4>FDG graph</h4>
                </div>
                <div class=card-body>
                    <div><em style="color: rgb(2, 117, 216)">Drawing and editing FDG graph on SVG: </em></div>
                    <svg width="720" height="350" id="test_svg"></svg>
                </div>
            </div>
            
        </div>

        <div class="col-6">
            <div class="row">


            <div class="col-6">
                <div class="card"  style="margin: 5px; height: 95%; width: 95%;">
                    <div class=card-header>
                        <h4>Gamedata</h4>
                    </div>
                    <div class=card-body style="ghostwhite">
                        <em style="color: rgb(2, 117, 216)" >Getting data summaries: </em>
                        <div id="test_data"></div>
                    </div>
                </div>
            </div>

            <div class="col-6">
                <div class="card" style="margin: 5px; height: 95%; width: 95%;">
                    <div class=card-header>
                        <h4>Traversal</h4>
                    </div>
                    <div class=card-body style="ghostwhite">
                        <em style="color: rgb(2, 117, 216)" >Expected sequence: </em>
                        <div id="test_expected"></div>
                        <em style="color: rgb(2, 117, 216)" >Depth-first traversal algorithm result: </em>
                        <div id="test_dfs"></div>
                    </div>
                </div>
            </div>

            <div class="col-6">
                <div class="card" style="margin: 5px; height: 95%; width: 95%;">
                    <div class=card-header>
                        <h4>Propagation</h4>
                    </div>
                    <div class=card-body style="ghostwhite">
                        <em style="color: rgb(2, 117, 216)" >Propagation algorithm result: </em>
                        <div id="test_dfs2"></div>
                    </div>
                </div>
            </div>

        </div>

    </div>

</body>

<footer>

    <!-- External dependencies -->
    <script src="../scripts/d3/d3.min.js"></script>
    <script src="../scripts/jsnx/jsnetworkx.js"></script>
    <script src="../scripts/big/big.min.js"></script>

    <!-- Data and data classes -->
    <script src="../data/data_json.js"></script>
    <script src="../data/data.js"></script>

    <!-- Methods -->
    <script src="debug/debug-methods.js"></script>
    <script src="../scripts/graph.js"></script>
    <script src="../algorithms/traversal.js"></script>
    <script src="../algorithms/mr-prop.js"></script>

    <script>

        /* 
        
        Data tests 
        =================
        These tests are designed to validate that the pseudo data classes import the MR data correctly, and all
        class methods for manipulating this data work as intended.

        */

        // Make main data objects used for game from starting MR data

        var data = new DataClass(data_json.nodes, data_json.edges); // Make DataClass pseudo data class for manipulating MR data
        var game =  new GameData(data_json.nodes, data_json.edges); // Make GameData pseudo data class for game variables

        // Test pseudo data classes

        propEbunch = data.toJsnx(); // Test returning data in jsnx graph format
            var G0 = new jsnx.DiGraph();
            G0.addEdgesFrom(propEbunch);
        game.addLogEntry('example entry'); // Test adding entry to log

        // Test data creation

        objSize_data = objSize(data); // DataClass
        objSize_nodes = objSize(data.nodes); // DataClass.nodes
        objSize_edges = objSize(data.edges); // DataClass.edges
        objSize_gameData = objSize(game) - objSize_data; // GameData
        document.getElementById('test_data').innerHTML = 'n edges: ' + objSize_edges + '<br>' + 'n nodes: ' + objSize_nodes+ '<br>' + 'n base data class: ' + objSize_data + '<br>' + 'n game variables: ' + objSize_gameData + '<br>';
        

        /* 
        
        Big.js tests
        =================
        This test is designed to validate that the Big number class increases floating point precision as intended

        */


        // Create big decimal object to test (20 DP by default)
        x = new Big(0.3)
        y = x.minus(0.1).valueOf() // js maths returns value of 0.19999998, big should correctly return 0.2


        /* 
        
        Directed Tr√©maux trees
        ===============
        These trees are constructed to test that the traversal algorithms can accurately traverse and produce paths for
        propagation travel from different types of networks. These trees feature different edge types and configurations
        which add complexity to traversing different networks and may cause failure in the traversal algorithms.
        These Network tests are designed to validate that the representation, traversal and propagation methods work as 
        intended and generalise to many different types of real-world networks.
        
        This list will be iterated over in testing the traversal and propagation algorithms.

        */

        tremauxTrees = [];

        /*


        Basic tree
        ----------
        Description: Basic linear tree with two branches tests whether algorithm is capable of basic travel and can traverse 
        branching paths (forks).

        Diagram:

                2
        0 - 1 <
                3 - 4

        */
       
        // JSNX graph object for basic tree
        var G_basic = new jsnx.DiGraph();
        G_basic.addEdgesFrom([[0,1], [1,2]]); // Primary branch
        G_basic.addEdgesFrom([[1,3], [3,4]]); // Fork to alternative branch
        
        tremauxTrees.push(G_basic);
        
        /*


        Cross-over tree
        ----------
        Description: Complex tree containing edges which cross over from one branch to another, as well as a forward edge.
        This tests whether the algorithm is capable of traversing cross edges and forward edges.

        Diagram:

                2 - 3
        0 - 1 <     |
                4 - 5 - 6
                \______/

        Search:0123456
        Exhaustion:
        */

        // JSNX graph object for cross-over tree
        var G_crossover = new jsnx.DiGraph();
        G_crossover.addEdgesFrom([[0,1], [1,2], [2,3]]); // Primary branch
        G_crossover.addEdgesFrom([[1,4], [4,5], [5,6]]); // Alternative branch
        G_crossover.addEdgesFrom([[3,5]]); // Cross edge
        G_crossover.addEdgesFrom([[4,6]]); // Forward edge
        
        tremauxTrees.push(G_crossover);

        /*


        Self-loop tree
        ----------
        Description: This tree contains a self loop to test whether the algorithm can traverse networks where one node
        has an edge to itself. These edges are illegal in MR and so are deleted.

        Diagram:

        0 - 1 - 2
            U

        */

        // JSNX graph object for self-loop tree
        var G_selfloop = new jsnx.DiGraph();
        G_selfloop.addEdgesFrom([[0,1], [1,2]]); // Primary branch
        G_selfloop.addEdgesFrom([[1,1]]); // Self-loop

        tremauxTrees.push(G_selfloop);
        /*


        Looping tree
        ----------
        Description: This tree contains a back edge which forms a loop, to test whether the algorithm is capable of traversing loops.

        Diagram:

        0 - 1 - 2
        ^       |
        |_______|

        */

        // JSNX graph object for looping tree
        var G_loop = new jsnx.DiGraph();
        G_loop.addCycle([0,1,2]); // Cycle

        //tremauxTrees.push(G_loop);
        
        /*


        Full tree
        ----------
        Description: This tree combines all of the above tests to test whether the algorithm can traverse a complex network.
        This tree is accurate of complex real-world MR network conditions.

        Diagram:

        / - - - - - - - - - 6
        |       2 - 3 - 4 <     
        0 - 1 <   /         5 
        ^       7 - 8 - 9  | 
        |       ^   U   |  |
        |       |_______|  |
        |                  |
        |__________________|
        nb: 3->7, 0->6
                            
        */

        // JSNX graph object for full tree
        var G_full = new jsnx.DiGraph();
        G_full.addEdgesFrom([[0,1], [1,2], [2,3], [3,4], [4,6], [4,5]]); // Primary branch
        G_full.addEdgesFrom([[1,7], [7,8], [8,9]]); // Alternative branch
        G_full.addEdgesFrom([[3,7]]); // Cross edge
        G_full.addEdgesFrom([[0,6]]); // Forward edge
        G_full.addEdgesFrom([[9,7], [5,0]]); // Back edges forming loops
        G_full.addEdgesFrom([[8,8]]); // Self-loop

        //tremauxTrees.push(G_full); 


        /* 

        Test functions 
        ==============
        These functions are designed to automate tests to test that the expected values from functions match their
        actual values. The tremaux trees are used as tests of different networks.
        
        */

        
        // Test self-loop identification and removal
        for (const tree of tremauxTrees){
            
            try {
                selfloops = G.selfloopEdges(); // Identify
                console.log('%cSelf-loop result: ', 'color: green;', selfloops)
                G.removeEdgesFrom(selfloops); // Remove
            }

            catch(err) {
                console.log('%cSelf-loop test failed', 'color: red;')
            }
            
        }

        // Test traversal
        for (const tree of tremauxTrees){
            
            try {
                
                const DFSpath = DFS(tree,0); // Initiate DFS search of graph G object from root node 0
                console.log('%cTraversal test result: ', 'color: green;', DFSpath) // Print path for propagation 
            }

            catch(err) {
                console.log('%cTraversal test failed', 'color: red;')
            }
            
        }

        // Method for testing whether self loop removal worked
        function checkSelfLoopsRemoved(){ // Test remove self loops
            for (const e of G_selfloop.edges()){
                if (e[0]+e[1] == 0){ // Test if any edges have the same source and target
                    return false;
                } else {
                    continue;
                }
            }
            return true;
        }

        // Compare expected and actual values
        tests = validate([

            // Check that data classes were created successfully
            {name : '[data] data.nodes (nodes exist)', expected : false, actual : (null == data.nodes)},
            {name : '[data] data.edges (edges exist)', expected : false, actual : (null == data.edges)},
            {name : '[data] game.objective (set objective)', expected : false, actual : (null == game.objective)},
            {name : '[data] game.log (init log)', expected : false, actual : (null == game.log)},

            // Check that PropagationData class works
            {name : '[data.js] PropagationData (ebunch)', expected : false, actual : undefined == propEbunch},

        ])

        if (tests['failed'].length > 0) {
            totalTests = tests['failed'].length + tests['passed'].length
            document.getElementById("test_results").innerText = "Failing automatic tests. " + tests['failed'].length + "/" + totalTests + " tests failed."
            messages="<strong>Log:</strong> <br>"
            for (const failure of tests['failed']){
                messages += failure + '<br>'
            }
            document.getElementById("test_log").innerHTML = messages;
            document.getElementById("test_results").style.backgroundColor = 'lightcoral';
        } else {
            document.getElementById("test_results").innerText = "Passing automatic tests (" + tests['passed'].length + "/" + tests['passed'].length + ")";
            document.getElementById("test_results").style.backgroundColor = 'lightgreen';
        }
    </script>

</footer>

</html>