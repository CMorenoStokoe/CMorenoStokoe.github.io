<html>

    <!--

    Data test page
    ---------------
    
    Intended purpose:

    Testing that data, graph theory and propagation functions 
    work in their intended purpose by performing content 
    and existence checks.
    
    -->

<head>

    <!-- Bootstrap css theme --> 
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    
    <!-- Fa icons -->
    <script src="https://kit.fontawesome.com/ff3502b087.js" crossorigin="anonymous"></script>
    
</head>

<body style="font-family: consolas;">

    <style>
        .created_class{border: 0.1pt solid rgb(150, 150, 150); padding: 20px;}
        .blue{font-size: 1.1em;}
    </style>

    <h1>Test page</h1>
    <p id="test_results" style="margin-bottom: 0px; background-color: red;">Testing failure. Check console.</p>
    <p id="test_log" style="color: white; background-color: black;"></p>


    <div class="row">
        
        <div class="col-6">

            <div class="card"  style="margin: 5px; height: 95%; width: 95%;">
                <div class=card-header>
                    <h4>FDG graph</h4>
                </div>
                <div class=card-body>
                    <div><em style="color: rgb(2, 117, 216)">Drawing and editing FDG graph on SVG: </em></div>
                    <svg width="720" height="350" id="test_svg"></svg>
                </div>
            </div>
            
        </div>

        <div class="col-6">
            <div class="row">


            <div class="col-6">
                <div class="card"  style="margin: 5px; height: 95%; width: 95%;">
                    <div class=card-header>
                        <h4>Gamedata</h4>
                    </div>
                    <div class=card-body style="ghostwhite">
                        <em style="color: rgb(2, 117, 216)" >Getting data summaries: </em>
                        <div id="test_data"></div>
                    </div>
                </div>
            </div>

            <div class="col-6">
                <div class="card" style="margin: 5px; height: 95%; width: 95%;">
                    <div class=card-header>
                        <h4>Traversal</h4>
                    </div>
                    <div class=card-body style="ghostwhite">
                        <em style="color: rgb(2, 117, 216)" >Expected sequence: </em>
                        <div id="test_expected"></div>
                        <em style="color: rgb(2, 117, 216)" >Depth-first traversal algorithm result: </em>
                        <div id="test_dfs"></div>
                    </div>
                </div>
            </div>

            <div class="col-6">
                <div class="card" style="margin: 5px; height: 95%; width: 95%;">
                    <div class=card-header>
                        <h4>Propagation</h4>
                    </div>
                    <div class=card-body style="ghostwhite">
                        <em style="color: rgb(2, 117, 216)" >Propagation algorithm result: </em>
                        <div id="test_dfs2"></div>
                    </div>
                </div>
            </div>

        </div>

    </div>

</body>

<footer>

    <!-- External dependencies -->
    <script src="../scripts/d3/d3.min.js"></script>
    <script src="../scripts/jsnx/jsnetworkx.js"></script>
    <script src="../scripts/big/big.min.js"></script>

    <!-- Data and data classes -->
    <script src="../data/data_json.js"></script>
    <script src="../data/data.js"></script>

    <!-- Methods -->
    <script src="debug/debug-methods.js"></script>
    <script src="../scripts/graph.js"></script>
    <script src="../algorithms/traversal.js"></script>
    <script src="../algorithms/mr-prop.js"></script>

    <script>

        /* 
        
        Data tests 
        -----------------
        These tests are designed to validate that the pseudo data classes import the MR data correctly, and all
        class methods for manipulating this data work as intended.

        */

        // Make main data objects used for game from starting MR data

        var data = new DataClass(data_json.nodes, data_json.edges); // Make DataClass pseudo data class for manipulating MR data
        var game =  new GameData(data_json.nodes, data_json.edges); // Make GameData pseudo data class for game variables

        // Test pseudo data classes

        propEbunch = data.toJsnx(); // Test returning data in jsnx graph format
            var G0 = new jsnx.DiGraph();
            G0.addEdgesFrom(propEbunch);
        game.addLogEntry('example entry'); // Test adding entry to log

        // Test data creation

        objSize_data = objSize(data); // DataClass
        objSize_nodes = objSize(data.nodes); // DataClass.nodes
        objSize_edges = objSize(data.edges); // DataClass.edges
        objSize_gameData = objSize(game) - objSize_data; // GameData
        document.getElementById('test_data').innerHTML = 'n edges: ' + objSize_edges + '<br>' + 'n nodes: ' + objSize_nodes+ '<br>' + 'n base data class: ' + objSize_data + '<br>' + 'n game variables: ' + objSize_gameData + '<br>';
        

        /* 
        
        Big.js tests
        -----------------
        This test is designed to validate that the Big number class increases floating point precision as intended

        */


        // Create big decimal object to test (20 DP by default)
        x = new Big(0.3)
        console.log(x.minus(0.1).valueOf()) // js maths returns value of 0.19999998, big should correctly return 0.2


        /* 
        
        Network test A - All edge types
        -----------------
        This is a standard Trémaux tree test that all possible edges are representable and traversible by the network algorithm.
        These Network tests are designed to validate that the representation, traversal and propagation methods work as intended.

        */


        // Initialise Trémaux tree with nodes

        var G = new jsnx.DiGraph(); // Create jsnx graph object

        G.addNodesFrom([ // Populate graph with nodes which have properties
            [0, {label : 'A', value: 0.25}],
            [1, {label : 'B', value: 0.25}],
            [2, {label : 'C', value: 0.25}],
            [3, {label : 'D', value: 0.25}],
            [4, {label : 'E', value: 0.25}],
            [5, {label : 'F', value: 0.25}],
            [6, {label : 'G', value: 0.25}],
            [7, {label : 'H', value: 0.25}],
        ]);

        // Add all types of edges to Trémaux tree

        G.addEdgesFrom([[0,1], [1,2], [2,3]]); // Primary branch
        G.addEdgesFrom([[0,4], [4,5]]); // Fork to alternative branch
        G.addEdgesFrom([[5,6], [5,7]]); // Fork to dead ends
        //G.addEdgesFrom([[3,1]]); // Back edge
        //G.addEdgesFrom([[0,7]]); // Forward edge
        G.addEdgesFrom([[5,2]]); // Cross edge
        G.addEdgesFrom([[0,0]]); // Self loop

        // Remove self loops from graph

        selfloops = G.selfloopEdges(); // Identify
        G.removeEdgesFrom(selfloops); // Remove

        function checkSelfLoopsRemoved(){ // Test remove self loops
            for (const e of G.edges()){
                if (e[0]+e[1] == 0){ // Test if any edges have the same source and target
                    return false;
                } else {
                    continue;
                }
            }
            return true;
        }

        // Test propagation

        const DFSpath = DFS(G,0); // Initiate DFS search of graph G object from root node 0
        console.log(DFSpath) // Print path for propagation 
        

        /* 
        
        Network test B - Complex loop interactions
        -----------------
        This is a Trémaux tree test which features many loops with complex interaction patterns which tests that the loop detection algorithms
        are accurate still in complex real-world conditions.
        These Network tests are designed to validate that the representation, traversal and propagation methods work as intended.

        


        // Create complex Trémaux tree

        var G2 = new jsnx.DiGraph(); // Create jsnx graph object

        // Add edges to graph
        G2.addCycle([0,1,2,3,4,5]); // Long loop
        G2.addCycle([2,5]); // Shortcut loop
        G2.addCycle([0,3,5]); // Loop with multiple intersection points


        // Remove self loops from graph

        selfloops = G.selfloopEdges(); // Identify
        G.removeEdgesFrom(selfloops); // Remove

        // Find conventional loops in graph

        loops = findLoops(G2, 0); // Find loops

        // Test BFS

        correct = [[0,7],[0,4],[4,5],[5,7],[5,6],[5,2],[2,3],[3,1],[1,2],[0,1]];
        document.getElementById('test_dfs').innerHTML = DFSpath.toString(); // Write test results for validation
        document.getElementById('test_expected').innerHTML = correct.toString();
        function checkPaths(){ // Test DFS path is the expected path
            if(correct.toString() == DFSpath.toString()){return true;} else {return false;}}


        /* 

        Test functions 
        ==============
        These functions are designed to automate tests to test that the expected values from functions match their
        actual values.
        
        */


        tests = validate([

            // Check that data classes were created successfully
            {name : '[data] data.nodes (nodes exist)', expected : false, actual : (null == data.nodes)},
            {name : '[data] data.edges (edges exist)', expected : false, actual : (null == data.edges)},
            {name : '[data] game.objective (set objective)', expected : false, actual : (null == game.objective)},
            {name : '[data] game.log (init log)', expected : false, actual : (null == game.log)},

            // Check graph object and traversal algorithm
            {name : '[traversal.js] BFS path (return path)', expected : true, actual : checkPaths()},
            {name : '[jsnetworkx.js] BFS path (return path)', expected : true, actual : checkSelfLoopsRemoved()},

            // Check that PropagationData class works
            {name : '[data.js] PropagationData (ebunch)', expected : false, actual : undefined == propEbunch},
            {name : '[data.js] PropagationData (ebunch is jsnx valid)', expected : false, actual : undefined == DFSpath2},

        ])

        if (tests['failed'].length > 0) {
            totalTests = tests['failed'].length + tests['passed'].length
            document.getElementById("test_results").innerText = "Failing automatic tests. " + tests['failed'].length + "/" + totalTests + " tests failed."
            messages="<strong>Log:</strong> <br>"
            for (const failure of tests['failed']){
                messages += failure + '<br>'
            }
            document.getElementById("test_log").innerHTML = messages;
            document.getElementById("test_results").style.backgroundColor = 'lightcoral';
        } else {
            document.getElementById("test_results").innerText = "Passing automatic tests (" + tests['passed'].length + "/" + tests['passed'].length + ")";
            document.getElementById("test_results").style.backgroundColor = 'lightgreen';
        }
    </script>

</footer>

</html>